#DailyWebCrawler_FitchRatingNews
#註解使用chromefdriver
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
import pandas as pd
import time

options = Options()
options.add_argument("--headless")
#service = Service("D:\chromedriver.exe")
#driver = webdriver.Chrome(service=service, options=options)
driver = webdriver.Chrome(options=options)
url = "https://www.fitchratings.com/zh-tw/region/taiwan-china"
driver.get(url)
time.sleep(5)

data = set()  # 用 set 避免重複
start_time = time.time()

while time.time() - start_time < 120:  # 抓 60 秒
    articles = driver.find_elements(By.CSS_SELECTOR, "article.rating-teaser")
    for article in articles:
        try:
            date = article.find_element(By.CSS_SELECTOR, "div.heading--sub").text
            title = article.find_element(By.CSS_SELECTOR, "h3.heading").text
            link = article.find_element(By.TAG_NAME, "a").get_attribute("href")
            data.add((date, title, link))
        except:
            continue
    time.sleep(3)  # 等待跑馬燈刷新

driver.quit()

# 存成 Excel  置換換空直
df = pd.DataFrame(list(data), columns=["Date", "Title", "Link"])
df.replace('', pd.NA, inplace=True)
df=df.dropna(subset=['Title', 'Date','Link'])
df['Date'] = pd.to_datetime(df['Date'], format='%a %d %b, %Y')  # 解析原始格式
df['Date'] = df['Date'].dt.strftime('%Y/%m/%d')  # 轉換成指定格式



from sqlalchemy import create_engine
import pyodbc


# 假設 df 是清理後的 DataFrame
# df = df.dropna(how='any')  # 清理空值

# SQL Server 連線字串
server = '172.21.118.27'
database = 'Fitch'
username = 'sa'
password = 'aslopin0211'
connection_string = f"mssql+pyodbc://{username}:{password}@{server}/{database}?driver=ODBC+Driver+17+for+SQL+Server"
engine = create_engine(connection_string)


# 4. 從資料庫讀取現有資料，避免插入重複
conn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')
existing = pd.read_sql("SELECT Date, Title, Link FROM dbo.CreditRatingNews", conn)

cursor=conn.cursor()
cursor.execute("DELETE FROM dbo.CreditRatingNews")
conn.commit()


# 比對，保留新資料
df = df.merge(existing, on=['Date', 'Title', 'Link'], how='left', indicator=True)
df = df[df['_merge'] == 'left_only'].drop(columns=['_merge'])

df = df.sort_values(by='Date', ascending=False)

if not df.empty:
    df.to_sql('CreditRatingNews', con=engine, schema='dbo', if_exists='append', index=False)
    print(f"成功插入 {len(df)} 筆新資料")
else:
    print("沒有新資料需要插入")
